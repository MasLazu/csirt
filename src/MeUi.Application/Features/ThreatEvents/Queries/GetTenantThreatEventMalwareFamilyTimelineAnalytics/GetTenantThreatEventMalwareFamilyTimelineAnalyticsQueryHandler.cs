using MediatR;
using MeUi.Application.Interfaces;
using MeUi.Application.Models.Analytics;

namespace MeUi.Application.Features.ThreatEvents.Queries.GetTenantThreatEventMalwareFamilyTimelineAnalytics;

public class GetTenantThreatEventMalwareFamilyTimelineAnalyticsQueryHandler : IRequestHandler<GetTenantThreatEventMalwareFamilyTimelineAnalyticsQuery, ThreatEventTimelineAnalyticsDto>
{
    private readonly IThreatEventAnalyticsRepository _repo;

    public GetTenantThreatEventMalwareFamilyTimelineAnalyticsQueryHandler(IThreatEventAnalyticsRepository repo)
    {
        _repo = repo;
    }

    public async Task<ThreatEventTimelineAnalyticsDto> Handle(GetTenantThreatEventMalwareFamilyTimelineAnalyticsQuery request, CancellationToken ct)
    {
        DateTime end = request.EndTime ?? DateTime.UtcNow;
        DateTime start = request.StartTime ?? end.AddDays(-7);
        if (start.Kind != DateTimeKind.Utc) start = start.ToUniversalTime();
        if (end.Kind != DateTimeKind.Utc) end = end.ToUniversalTime();

        var window = end - start;
        DateTime comparisonEnd = start;
        DateTime comparisonStart = comparisonEnd - window;

        var raw = (await _repo.GetTimelineAnalyticsAsync(start, end, request.Interval, request.TenantId, category: null, malwareFamilyId: request.MalwareFamilyId, sourceCountryId: null, ct)).ToList();
        var malwareTimeline = (await _repo.GetMalwareTimelineAnalyticsAsync(start, end, request.Interval, request.TenantId, ct)).ToList();
        var previousRaw = (await _repo.GetTimelineAnalyticsAsync(comparisonStart, comparisonEnd, request.Interval, request.TenantId, category: null, malwareFamilyId: request.MalwareFamilyId, sourceCountryId: null, ct)).ToList();
        var previousMalwareTimeline = (await _repo.GetMalwareTimelineAnalyticsAsync(comparisonStart, comparisonEnd, request.Interval, request.TenantId, ct)).ToList();

        var grouped = raw
            .GroupBy(r => r.Timestamp)
            .Select(g => new ThreatEventTimelineDto
            {
                Timestamp = g.Key,
                EventCount = g.Sum(x => x.Count),
                Categories = g.ToDictionary(x => x.Category, x => x.Count),
                Severity = new(),
                MalwareFamilies = malwareTimeline.Where(m => m.Timestamp == g.Key)
                    .GroupBy(m => m.MalwareFamilyName)
                    .ToDictionary(x => x.Key, x => x.Sum(z => z.Count))
            }).OrderBy(t => t.Timestamp).ToList();

        var prevGroupedCounts = previousRaw
            .GroupBy(r => r.Timestamp)
            .ToDictionary(g => g.Key, g => g.Sum(x => x.Count));

        foreach (var bucket in grouped)
        {
            if (prevGroupedCounts.TryGetValue(bucket.Timestamp - window, out int prevCount))
            {
                double change = prevCount == 0 ? 100 : ((double)bucket.EventCount - prevCount) / prevCount * 100.0;
                bucket.Severity["_trend_pct"] = (int)Math.Round(change);
            }
        }

        int totalCurrent = grouped.Sum(t => t.EventCount);
        int totalPrevious = previousRaw.Sum(r => r.Count);
        double pctChange = totalPrevious == 0 ? 100 : ((double)totalCurrent - totalPrevious) / totalPrevious * 100.0;
        string direction = totalCurrent > totalPrevious ? "increasing" : totalCurrent < totalPrevious ? "decreasing" : "stable";

        return new ThreatEventTimelineAnalyticsDto
        {
            Timeline = grouped,
            TotalEvents = totalCurrent,
            Interval = request.Interval,
            TimeRange = new TimeRangeDto { Start = start, End = end },
            Trends = new TrendAnalysisDto
            {
                PercentageChange = pctChange,
                Direction = direction,
                ComparisonPeriodStart = comparisonStart,
                ComparisonPeriodEnd = comparisonEnd
            }
        };
    }
}
