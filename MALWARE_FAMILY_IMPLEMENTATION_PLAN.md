# MalwareFamily Management Implementation Plan

## ğŸ¯ Overview
Implementing comprehensive MalwareFamily management system following the same patterns established for Country management.

## ğŸ“Š Current State Analysis
- âœ… `MalwareFamily` entity exists (`Name` property, relationships to `ThreatEvent`)
- âœ… `MalwareFamilyDto` exists and matches entity structure  
- âŒ No MalwareFamily management endpoints implemented
- âŒ No MalwareFamily CRUD operations
- âŒ No tenant-malware family assignment (similar to countries)

## ğŸ—ï¸ Proposed Implementation: Global MalwareFamily Management

Similar to Countries, MalwareFamilies should be treated as **global reference data** that all tenants can access.

### ğŸ“‹ **Implementation Approach: Global Reference Data**

**Rationale:**
- No `TenantMalwareFamily` entity exists in domain model
- MalwareFamilies are typically standard cybersecurity classifications
- Global malware family taxonomy benefits all tenants
- Simpler management as reference data

**Global MalwareFamily Management Endpoints:**
- `GET /api/v1/malware-families` - List all malware families (paginated, searchable)
- `GET /api/v1/malware-families/{id}` - Get malware family by ID
- `POST /api/v1/malware-families` - Create malware family (admin only)
- `PUT /api/v1/malware-families/{id}` - Update malware family (admin only)
- `DELETE /api/v1/malware-families/{id}` - Delete malware family (admin only)

## ğŸ” Proposed Permissions

### Admin Permissions:
- `CREATE:MALWARE_FAMILY` - Create new malware families
- `READ:MALWARE_FAMILY` - View all malware families
- `UPDATE:MALWARE_FAMILY` - Modify malware families  
- `DELETE:MALWARE_FAMILY` - Remove malware families

### Tenant User Permissions:
- `READ:MALWARE_FAMILY` - View all malware families (global reference data)

## ğŸ“ Required File Structure

### Application Layer
```
/src/MeUi.Application/Features/MalwareFamilies/
â”œâ”€â”€ Commands/
â”‚   â”œâ”€â”€ CreateMalwareFamily/ (Command, Handler, Validator)
â”‚   â”œâ”€â”€ UpdateMalwareFamily/ (Command, Handler, Validator)
â”‚   â””â”€â”€ DeleteMalwareFamily/ (Command, Handler, Validator)
â””â”€â”€ Queries/
    â”œâ”€â”€ GetMalwareFamiliesPaginated/ (Query, Handler, Validator)
    â””â”€â”€ GetMalwareFamily/ (Query, Handler, Validator)
```

### API Layer
```
/src/MeUi.Api/Endpoints/MalwareFamilies/
â”œâ”€â”€ CreateMalwareFamilyEndpoint.cs
â”œâ”€â”€ GetMalwareFamiliesEndpoint.cs
â”œâ”€â”€ GetMalwareFamilyByIdEndpoint.cs
â”œâ”€â”€ UpdateMalwareFamilyEndpoint.cs
â””â”€â”€ DeleteMalwareFamilyEndpoint.cs
```

## ğŸ“‹ Validation Rules

### MalwareFamily Validation:
- `Name`: Required, 2-100 characters
- `Name`: Must be unique globally
- `Name`: Alphanumeric, spaces, hyphens, underscores allowed
- `Name`: Case-insensitive uniqueness check

### Business Rules:
- Cannot delete malware families referenced by threat events
- Names should follow cybersecurity naming conventions
- Trim whitespace and normalize casing

## âœ¨ Key Features

### Data Management:
- âœ… Global malware family taxonomy
- âœ… Unique name validation
- âœ… Referential integrity with threat events
- âœ… Case-insensitive search and uniqueness

### Query Features:
- âœ… Database-level pagination using `BasePaginatedQuery<MalwareFamilyDto>`
- âœ… Search by name (case-insensitive)
- âœ… Sortable by Name, CreatedAt, UpdatedAt (default: Name)
- âœ… Optimized database queries

### Security:
- âœ… Permission-based authorization (`IPermissionProvider`)
- âœ… Admin-only CRUD operations
- âœ… Global read access for tenant users
- âœ… Proper error handling and validation

## ğŸ¯ Business Logic

### Create MalwareFamily:
1. Validate name format and requirements
2. Check for duplicate names (case-insensitive)
3. Normalize name (trim, proper casing)
4. Create with generated ID and timestamp

### Update MalwareFamily:
1. Verify malware family exists
2. Check for name conflicts with other families
3. Normalize and update name
4. Update timestamp

### Delete MalwareFamily:
1. Verify malware family exists
2. Check for threat event references
3. Prevent deletion if referenced
4. Safe removal if no dependencies

### Search & Sort:
- Search: Case-insensitive name matching
- Sort: Name (default), CreatedAt, UpdatedAt
- Pagination: Database-level with proper performance

## ğŸ§ª Quality Assurance

### Validation:
- Comprehensive FluentValidation rules
- Business rule enforcement
- Proper error responses

### Performance:
- Database-level filtering and pagination
- Optimized query expressions
- Minimal data transfer

### Security:
- Permission-based access control
- Input sanitization and validation
- Proper exception handling

## ğŸš€ Implementation Steps

1. **Create Application Layer Commands** (Create, Update, Delete)
2. **Create Application Layer Queries** (GetPaginated, GetById)
3. **Implement API Endpoints** with proper permissions
4. **Add comprehensive validation** and error handling
5. **Build verification** and testing
6. **Commit and document** implementation

## ğŸ’¡ Example MalwareFamily Names
- APT29 (Cozy Bear)
- Emotet
- TrickBot
- Ransomware.WannaCry
- Trojan.Banker
- Backdoor.RemoteAccess
- Worm.Conficker
- Rootkit.Stuxnet

Would you like me to proceed with implementing this **Global MalwareFamily Management** system following this plan?
