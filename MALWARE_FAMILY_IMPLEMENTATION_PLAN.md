# MalwareFamily Management Implementation Plan

## 🎯 Overview
Implementing comprehensive MalwareFamily management system following the same patterns established for Country management.

## 📊 Current State Analysis
- ✅ `MalwareFamily` entity exists (`Name` property, relationships to `ThreatEvent`)
- ✅ `MalwareFamilyDto` exists and matches entity structure  
- ❌ No MalwareFamily management endpoints implemented
- ❌ No MalwareFamily CRUD operations
- ❌ No tenant-malware family assignment (similar to countries)

## 🏗️ Proposed Implementation: Global MalwareFamily Management

Similar to Countries, MalwareFamilies should be treated as **global reference data** that all tenants can access.

### 📋 **Implementation Approach: Global Reference Data**

**Rationale:**
- No `TenantMalwareFamily` entity exists in domain model
- MalwareFamilies are typically standard cybersecurity classifications
- Global malware family taxonomy benefits all tenants
- Simpler management as reference data

**Global MalwareFamily Management Endpoints:**
- `GET /api/v1/malware-families` - List all malware families (paginated, searchable)
- `GET /api/v1/malware-families/{id}` - Get malware family by ID
- `POST /api/v1/malware-families` - Create malware family (admin only)
- `PUT /api/v1/malware-families/{id}` - Update malware family (admin only)
- `DELETE /api/v1/malware-families/{id}` - Delete malware family (admin only)

## 🔐 Proposed Permissions

### Admin Permissions:
- `CREATE:MALWARE_FAMILY` - Create new malware families
- `READ:MALWARE_FAMILY` - View all malware families
- `UPDATE:MALWARE_FAMILY` - Modify malware families  
- `DELETE:MALWARE_FAMILY` - Remove malware families

### Tenant User Permissions:
- `READ:MALWARE_FAMILY` - View all malware families (global reference data)

## 📁 Required File Structure

### Application Layer
```
/src/MeUi.Application/Features/MalwareFamilies/
├── Commands/
│   ├── CreateMalwareFamily/ (Command, Handler, Validator)
│   ├── UpdateMalwareFamily/ (Command, Handler, Validator)
│   └── DeleteMalwareFamily/ (Command, Handler, Validator)
└── Queries/
    ├── GetMalwareFamiliesPaginated/ (Query, Handler, Validator)
    └── GetMalwareFamily/ (Query, Handler, Validator)
```

### API Layer
```
/src/MeUi.Api/Endpoints/MalwareFamilies/
├── CreateMalwareFamilyEndpoint.cs
├── GetMalwareFamiliesEndpoint.cs
├── GetMalwareFamilyByIdEndpoint.cs
├── UpdateMalwareFamilyEndpoint.cs
└── DeleteMalwareFamilyEndpoint.cs
```

## 📋 Validation Rules

### MalwareFamily Validation:
- `Name`: Required, 2-100 characters
- `Name`: Must be unique globally
- `Name`: Alphanumeric, spaces, hyphens, underscores allowed
- `Name`: Case-insensitive uniqueness check

### Business Rules:
- Cannot delete malware families referenced by threat events
- Names should follow cybersecurity naming conventions
- Trim whitespace and normalize casing

## ✨ Key Features

### Data Management:
- ✅ Global malware family taxonomy
- ✅ Unique name validation
- ✅ Referential integrity with threat events
- ✅ Case-insensitive search and uniqueness

### Query Features:
- ✅ Database-level pagination using `BasePaginatedQuery<MalwareFamilyDto>`
- ✅ Search by name (case-insensitive)
- ✅ Sortable by Name, CreatedAt, UpdatedAt (default: Name)
- ✅ Optimized database queries

### Security:
- ✅ Permission-based authorization (`IPermissionProvider`)
- ✅ Admin-only CRUD operations
- ✅ Global read access for tenant users
- ✅ Proper error handling and validation

## 🎯 Business Logic

### Create MalwareFamily:
1. Validate name format and requirements
2. Check for duplicate names (case-insensitive)
3. Normalize name (trim, proper casing)
4. Create with generated ID and timestamp

### Update MalwareFamily:
1. Verify malware family exists
2. Check for name conflicts with other families
3. Normalize and update name
4. Update timestamp

### Delete MalwareFamily:
1. Verify malware family exists
2. Check for threat event references
3. Prevent deletion if referenced
4. Safe removal if no dependencies

### Search & Sort:
- Search: Case-insensitive name matching
- Sort: Name (default), CreatedAt, UpdatedAt
- Pagination: Database-level with proper performance

## 🧪 Quality Assurance

### Validation:
- Comprehensive FluentValidation rules
- Business rule enforcement
- Proper error responses

### Performance:
- Database-level filtering and pagination
- Optimized query expressions
- Minimal data transfer

### Security:
- Permission-based access control
- Input sanitization and validation
- Proper exception handling

## 🚀 Implementation Steps

1. **Create Application Layer Commands** (Create, Update, Delete)
2. **Create Application Layer Queries** (GetPaginated, GetById)
3. **Implement API Endpoints** with proper permissions
4. **Add comprehensive validation** and error handling
5. **Build verification** and testing
6. **Commit and document** implementation

## 💡 Example MalwareFamily Names
- APT29 (Cozy Bear)
- Emotet
- TrickBot
- Ransomware.WannaCry
- Trojan.Banker
- Backdoor.RemoteAccess
- Worm.Conficker
- Rootkit.Stuxnet

Would you like me to proceed with implementing this **Global MalwareFamily Management** system following this plan?
